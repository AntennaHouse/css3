<?xml version="1.0" encoding="UTF-8"?>
<project name="dita2css3" default="dita2css3">

  <condition property="css3.dir" value="plugins${file.separator}css3">
    <not>
      <isset property="css3.dir"/>
    </not>
  </condition>

	<target name="dita2css3"
		  depends="build-init, preprocess">
		<property name="css3.merged.file" value="${dita.temp.dir}${file.separator}${dita.map.filename.root}_MERGED.xml"/>
		<antcall target="css3.xhtml-split">
		</antcall>
		<antcall target="css3.topicmerge">
			<param name="input" value="${dita.temp.dir}${file.separator}${user.input.file}"/>
		</antcall>
		<antcall target="css3.xhtml-single">
		</antcall>
		<antcall target="css3.pdf">
		</antcall>
	</target>

	<target name="css3.xhtml-split"
		  depends="dita.map.xhtml, copy-revflag, copy-css, dita.topics.xhtml, dita.inner.topics.xhtml, dita.outer.topics.xhtml">
	</target>

	<target name="css3.xhtml-single"
		  depends="dita.map.xhtml, copy-revflag, copy-css, dita.topics.xhtml, dita.inner.topics.xhtml, dita.outer.topics.xhtml">
	</target>

	<target name="css3.pdf">
		<antcall target="css3.map2pdf">
		</antcall>
		<antcall target="css3.clean-output-dir">
		</antcall>
	</target>

	<target name="css3.topicmerge">
		<dirname file="${dita.temp.dir}${file.separator}${user.input.file}"
			  property="dita.merged.dir" />
		<xslt processor="trax" in="${input}"
			  out="${css3.merged.file}"
			  style="${dita.script.dir}${file.separator}topicmerge.xsl">
		</xslt>
	</target>

	<target name="css3.map2pdf">
		<condition property="css3.stylesheet"
			  value="${css3.dir}${file.separator}css${file.separator}paginated.css">
			<not>
				<isset property="css3.stylesheet"/>
			</not>
		</condition>
		<!-- Temporary kludge to work around a bug in Formatter. -->
		<replace file="${css3.merged.file}" token="&amp;lt;?path2project?&amp;gt;">
		</replace>
		<exec executable="AHFCmd" failonerror="true">
			<arg value="-d"/>
			<arg value="${css3.merged.file}"/>
			<arg value="-s"/>
			<arg value="${css3.stylesheet}"/>
			<arg value="-o"/>
			<arg value="${output.dir}${file.separator}${dita.map.filename.root}.pdf"/>
			<arg value="-x"/>
			<arg value="4"/>
		</exec>
	</target>
	
	<target name="css3.clean-output-dir">
		<delete includeemptydirs="true">
			<fileset dir="${output.dir}">
				<exclude name="**/*.pdf"/>
			</fileset>
		</delete>
	</target>

</project>

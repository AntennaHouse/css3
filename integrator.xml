<?xml version="1.0" encoding="UTF-8"?>
<project name="dita2css3" default="dita2css3">

  <condition property="css3.dir" value="plugins${file.separator}css3">
    <not>
      <isset property="css3.dir"/>
    </not>
  </condition>

	<target name="dita2css3"
		  depends="build-init, preprocess">
		<property name="css3.merged.file" value="${output.dir}${file.separator}index-single.html"/>
		<antcall target="css3.xhtml-split">
		</antcall>
		<antcall target="css3.topicmerge">
		</antcall>
		<antcall target="css3.xhtml-single">
		</antcall>
		<!-- This is dependent on xhtml-singe
		<antcall target="css3.pdf">
		</antcall>
		-->
	</target>

	<target name="css3.xhtml-split"
		  depends="dita.map.xhtml, copy-revflag, copy-css, dita.topics.xhtml, dita.inner.topics.xhtml, dita.outer.topics.xhtml">
	</target>

	<target name="css3.xhtml-single"
		  depends="dita.map.xhtml, copy-revflag, copy-css, dita.topics.xhtml, dita.inner.topics.xhtml, dita.outer.topics.xhtml">
	</target>

	<target name="css3.pdf">
		<antcall target="css3.map2pdf">
		</antcall>
	</target>

	<target name="css3.topicmerge">
		<replace dir="${output.dir}" includes="**/*.html">
			<replacetoken>&amp;lt;!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&amp;gt;</replacetoken>
		</replace>
		<xslt processor="trax" in="${output.dir}${file.separator}index.html"
			  out="${css3.merged.file}"
			  style="${css3.dir}${file.separator}xsl${file.separator}merge_xhtml.xsl">
		</xslt>
	</target>

	<target name="css3.map2pdf">
		<condition property="css3.stylesheet"
			  value="${css3.dir}${file.separator}css${file.separator}paginated.css">
			<not>
				<isset property="css3.stylesheet"/>
			</not>
		</condition>
		<!-- Temporary kludge to work around a bug in Formatter. -->
		<replace file="${css3.merged.file}" token="&amp;lt;?path2project?&amp;gt;">
		</replace>
		<exec executable="AHFCmd" failonerror="true">
			<arg value="-d"/>
			<arg value="${css3.merged.file}"/>
			<arg value="-s"/>
			<arg value="${css3.stylesheet}"/>
			<arg value="-o"/>
			<arg value="${output.dir}${file.separator}${dita.map.filename.root}.pdf"/>
			<arg value="-x"/>
			<arg value="4"/>
		</exec>
	</target>
	
</project>
